# 🔄 Рабочие процессы бота

## 📱 Пользовательские сценарии

### Сценарий 1: Первый запуск

```
┌─────────────────────────────────────────────────────────┐
│ 1. Пользователь находит бота в Telegram                │
│    @minecraft_mods_bot                                  │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 2. Отправляет команду /start                           │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 3. Бот проверяет rate limit в Supabase                 │
│    - Первый запрос → разрешено                         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 4. Бот логирует запрос в user_requests                 │
│    user_id: 123456789                                   │
│    request_type: 'start'                                │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 5. Бот отправляет приветствие с меню                   │
│    ┌─────────────────────────────────┐                 │
│    │ 👋 Привет! Я бот для поиска     │                 │
│    │ модов Minecraft                 │                 │
│    │                                 │                 │
│    │ [🔧 Моды] [✨ Шейдеры]          │                 │
│    │ [🎨 Ресурспаки] [🔍 Поиск]     │                 │
│    └─────────────────────────────────┘                 │
└─────────────────────────────────────────────────────────┘
```

### Сценарий 2: Поиск и скачивание мода

```
┌─────────────────────────────────────────────────────────┐
│ 1. Пользователь нажимает кнопку "🔧 Моды"              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 2. Бот проверяет rate limit                            │
│    - Запросов за минуту: 1/3 → разрешено               │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 3. Бот запрашивает название мода                       │
│    "🔧 Введи название мода для поиска:"                │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 4. Пользователь вводит "JEI"                           │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 5. Бот отправляет запрос к Modrinth API                │
│    GET /v2/search?query=JEI&facets=[["project_type:mod"]]│
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 6. Modrinth возвращает результаты                      │
│    [                                                    │
│      {                                                  │
│        "title": "Just Enough Items (JEI)",            │
│        "downloads": 150000000,                         │
│        "description": "Item and Recipe viewing mod"    │
│      },                                                 │
│      ...                                                │
│    ]                                                    │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 7. Бот сохраняет в search_history                      │
│    query: "JEI"                                         │
│    result_count: 10                                     │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 8. Бот форматирует и отправляет результаты             │
│    ┌─────────────────────────────────┐                 │
│    │ 📦 Найдено результатов: 10      │                 │
│    │                                 │                 │
│    │ 1. Just Enough Items (JEI)     │                 │
│    │    📥 150M загрузок             │                 │
│    │    Item and Recipe viewing...   │                 │
│    │                                 │                 │
│    │ [1] [2] [3] [4] [5]            │                 │
│    │ [« Назад в меню]               │                 │
│    └─────────────────────────────────┘                 │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 9. Пользователь выбирает первый результат              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 10. Бот запрашивает версии мода                        │
│     GET /v2/project/{id}/version                        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 11. Бот показывает доступные версии                    │
│     ┌─────────────────────────────────┐                │
│     │ 📋 Доступные версии:            │                │
│     │                                 │                │
│     │ 1. 15.2.0.27                   │                │
│     │    🎮 1.20.1                    │                │
│     │    ⚙️ Forge                     │                │
│     │                                 │                │
│     │ 2. 15.2.0.26                   │                │
│     │    🎮 1.20.1                    │                │
│     │    ⚙️ Forge                     │                │
│     │                                 │                │
│     │ [Версия 1] [Версия 2] ...      │                │
│     └─────────────────────────────────┘                │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 12. Пользователь выбирает версию                       │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 13. Бот проверяет размер файла                         │
│     file_size: 1.2 MB < 50 MB → можно отправить        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 14. Бот скачивает файл                                 │
│     axios.get(file_url, { responseType: 'arraybuffer' })│
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 15. Бот отправляет файл пользователю                   │
│     ctx.replyWithDocument({ source: buffer })           │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 16. Пользователь получает файл                         │
│     ┌─────────────────────────────────┐                │
│     │ 📄 jei-1.20.1-forge-15.2.0.27.jar│              │
│     │ 📦 1.2 MB                       │                │
│     │ 🎮 1.20.1                       │                │
│     │                                 │                │
│     │ [Скачать]                      │                │
│     └─────────────────────────────────┘                │
└─────────────────────────────────────────────────────────┘
```

### Сценарий 3: Rate Limiting

```
┌─────────────────────────────────────────────────────────┐
│ 1. Пользователь быстро нажимает кнопки                 │
│    Запрос 1 → OK                                        │
│    Запрос 2 → OK                                        │
│    Запрос 3 → OK                                        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 2. Четвёртый запрос                                    │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 3. Бот проверяет rate limit                            │
│    SELECT COUNT(*) FROM user_requests                   │
│    WHERE user_id = 123456789                            │
│    AND timestamp > NOW() - INTERVAL '1 minute'          │
│    → Результат: 3 запроса                              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 4. Лимит достигнут (3/3)                               │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 5. Бот отклоняет запрос                                │
│    ctx.answerCbQuery('⏳ Слишком много запросов...')   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 6. Пользователь видит уведомление                      │
│    "⏳ Слишком много запросов. Подожди минуту."        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 7. Через 60 секунд счётчик сбрасывается                │
│    Пользователь может снова делать запросы             │
└─────────────────────────────────────────────────────────┘
```

## 🔧 Технические процессы

### Процесс деплоя

```
┌─────────────────────────────────────────────────────────┐
│ 1. Разработчик вносит изменения                        │
│    - Редактирует src/bot.ts                            │
│    - Добавляет новую функцию                           │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 2. Локальное тестирование                              │
│    npm run dev                                          │
│    - Бот запускается в long polling режиме             │
│    - Тестирование в Telegram                           │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 3. Проверка TypeScript                                 │
│    npm run type-check                                   │
│    - Проверка типов                                     │
│    - Поиск ошибок                                       │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 4. Сборка проекта                                      │
│    npm run build                                        │
│    - Компиляция TypeScript → JavaScript                │
│    - Создание dist/ папки                              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 5. Коммит изменений                                    │
│    git add .                                            │
│    git commit -m "Add new feature"                      │
│    git push                                             │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 6. Деплой на Vercel                                    │
│    vercel --prod                                        │
│    - Загрузка файлов                                    │
│    - Сборка на сервере                                  │
│    - Создание serverless функций                        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 7. Vercel возвращает URL                               │
│    https://minecraft-mods-bot.vercel.app                │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 8. Установка вебхука                                   │
│    GET https://minecraft-mods-bot.vercel.app/api/webhook│
│    - Telegram API: setWebhook()                         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 9. Бот готов к работе                                  │
│    - Webhook активен                                    │
│    - Serverless функции запущены                        │
└─────────────────────────────────────────────────────────┘
```

### Процесс обработки webhook

```
┌─────────────────────────────────────────────────────────┐
│ 1. Telegram отправляет update на webhook               │
│    POST https://your-app.vercel.app/api/webhook         │
│    {                                                    │
│      "update_id": 123456789,                           │
│      "message": {                                       │
│        "from": { "id": 123456789 },                    │
│        "text": "/start"                                 │
│      }                                                  │
│    }                                                    │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 2. Vercel получает запрос                              │
│    - Холодный старт (если нужно): ~200ms               │
│    - Загрузка кода                                      │
│    - Инициализация бота                                 │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 3. api/webhook.ts обрабатывает запрос                  │
│    await bot.handleUpdate(req.body)                     │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 4. Telegraf маршрутизирует update                      │
│    - Определяет тип (command/text/callback)            │
│    - Находит соответствующий handler                    │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 5. Handler выполняется                                 │
│    bot.command('start', async (ctx) => {               │
│      // Логика обработки                               │
│    })                                                   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 6. Взаимодействие с внешними сервисами                 │
│    - Supabase: проверка rate limit                     │
│    - Modrinth API: поиск модов                         │
│    - CurseForge API: поиск модов                       │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 7. Отправка ответа пользователю                        │
│    await ctx.reply('Ответ')                            │
│    - Telegram API: sendMessage()                        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 8. Возврат 200 OK в Telegram                           │
│    res.status(200).json({ ok: true })                   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 9. Serverless функция завершается                      │
│    - Освобождение ресурсов                             │
│    - Ожидание следующего запроса                       │
└─────────────────────────────────────────────────────────┘
```

## 📊 Процесс аналитики

### Сбор данных

```
Каждый запрос пользователя
        ↓
┌───────────────────┐
│ Логирование в БД  │
├───────────────────┤
│ user_requests     │ ← Rate limiting
│ search_history    │ ← Аналитика поиска
│ download_stats    │ ← Статистика скачиваний
└───────────────────┘
        ↓
┌───────────────────┐
│ Автоочистка       │
│ (каждый день)     │
├───────────────────┤
│ > 7 дней          │ → Удаление
│ > 30 дней         │ → Удаление
│ > 90 дней         │ → Удаление
└───────────────────┘
```

### Анализ данных

```
SQL запросы в Supabase
        ↓
┌───────────────────────────────┐
│ Топ пользователей             │
│ Популярные запросы            │
│ Статистика скачиваний         │
│ Активность по времени         │
└───────────────────────────────┘
        ↓
┌───────────────────────────────┐
│ Визуализация                  │
│ (Supabase Dashboard)          │
└───────────────────────────────┘
```

## 🔄 Жизненный цикл данных

```
Пользователь делает запрос
        ↓
Данные записываются в Supabase
        ↓
Хранятся 7-90 дней (в зависимости от таблицы)
        ↓
Автоматически удаляются функцией cleanup_old_data()
        ↓
База данных остаётся компактной
```

## 🎯 Критические пути

### Путь 1: Быстрый ответ (< 2 секунды)

```
User → Telegram → Webhook → Vercel → Bot → Response
                    ↓
              Rate Limit Check (Supabase)
                    ↓
                  < 100ms
```

### Путь 2: Поиск мода (< 5 секунд)

```
User → Search Query → Modrinth API → Results → Format → Send
                          ↓
                    1-2 секунды
```

### Путь 3: Скачивание файла (< 30 секунд)

```
User → Select Version → Download → Buffer → Send
                          ↓
                    5-25 секунд (зависит от размера)
```

---

**Все процессы оптимизированы для быстрой работы!** ⚡
